{"version":3,"sources":["../src/kekuleMoodle.js"],"names":["define","init","root","window","KekuleMoodle","WidgetDataWrapper","WRAPPER_HTML_CLASS","WRAPPER_DATA_HTML_CLASS","ALLOWED_TAGNAMES","ALLOWED_ATTRIBS","_matchAttribPatterns","attribName","patterns","i","l","length","match","convertWrapperElem","elem","autoLaunchWidget","content","Kekule","HtmlElementUtils","getInnerText","jsonObj","JSON","parse","tagName","indexOf","toLowerCase","DomUtils","clearChildContent","targetElem","newCreated","ownerDocument","createElement","attrib","value","setAttribute","console","log","removeClass","appendChild","Widget","autoLauncher","execute","e","launchOnElem","isContentEditable","getWidgetOnElem","hasClass","children","getDirectChildElems","child","launchOnDoc","doc","document","body","X","domReady","_ready"],"mappings":"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","sourcesContent":["define(/*'local_kekulejs/kekuleMoodle',*/ ['kekule', 'local_kekulejs/kekuleInitials'], function(){\r\n\r\n\tfunction init()\r\n\t{\r\n\t\tvar root = window;\r\n\t\tvar KekuleMoodle = {\r\n\t\t\t// Widget wrapper, which may wrap widget data in content (not attribute) of element,\r\n\t\t\tWidgetDataWrapper: {\r\n\t\t\t\tWRAPPER_HTML_CLASS: 'KekuleMoodle-Widget-Data-Wrapper',\r\n\t\t\t\tWRAPPER_DATA_HTML_CLASS: 'KekuleMoodle-Widget-Data',\r\n\r\n\t\t\t\t// only can apply to these tag names and attribs, avoid security problem\r\n\t\t\t\tALLOWED_TAGNAMES: ['div', 'span', 'img', 'p', 'section'],\r\n\t\t\t\tALLOWED_ATTRIBS: ['class', 'style', 'id', 'name', 'width', 'height', /^data-/],\r\n\r\n\t\t\t\t_matchAttribPatterns: function(attribName, patterns)\r\n\t\t\t\t{\r\n\t\t\t\t\tfor (var i = 0, l = patterns.length; i < l; ++i)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (attribName.match(patterns[i]))\r\n\t\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t},\r\n\r\n\t\t\t\tconvertWrapperElem: function(elem, autoLaunchWidget)\r\n\t\t\t\t{\r\n\t\t\t\t\tvar content = Kekule.HtmlElementUtils.getInnerText(elem);\r\n\t\t\t\t\t//content = decodeHTMLEntities(content);\r\n\t\t\t\t\ttry\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar jsonObj = JSON.parse(content);\r\n\t\t\t\t\t\tif (jsonObj)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvar tagName = jsonObj.tagName || elem.tagName;\r\n\t\t\t\t\t\t\tif (KekuleMoodle.WidgetDataWrapper.ALLOWED_TAGNAMES.indexOf(tagName.toLowerCase()) < 0)  // tag name not allowed\r\n\t\t\t\t\t\t\t\treturn null;\r\n\r\n\t\t\t\t\t\t\t//console.log('wrapper', jsonObj);\r\n\r\n\t\t\t\t\t\t\tKekule.DomUtils.clearChildContent(elem);\r\n\t\t\t\t\t\t\tvar targetElem = elem;\r\n\t\t\t\t\t\t\tvar newCreated = false;\r\n\t\t\t\t\t\t\tif (jsonObj.tagName)  // explicit set tagName, need to create new element\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\ttargetElem = elem.ownerDocument.createElement(jsonObj.tagName);\r\n\t\t\t\t\t\t\t\tnewCreated = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tfor (var attrib in jsonObj)\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tif (attrib !== 'tagName' && KekuleMoodle.WidgetDataWrapper._matchAttribPatterns(attrib, KekuleMoodle.WidgetDataWrapper.ALLOWED_ATTRIBS))\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\tvar value = jsonObj[attrib];\r\n\t\t\t\t\t\t\t\t\ttargetElem.setAttribute(attrib, value);\r\n\t\t\t\t\t\t\t\t\tconsole.log('set attrib', attrib, value);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tKekule.HtmlElementUtils.removeClass(elem, KekuleMoodle.WidgetDataWrapper.WRAPPER_HTML_CLASS);\r\n\t\t\t\t\t\t\tif (newCreated)\r\n\t\t\t\t\t\t\t\telem.appendChild(targetElem);\r\n\t\t\t\t\t\t\tif (autoLaunchWidget)\r\n\t\t\t\t\t\t\t\tKekule.Widget.autoLauncher.execute(targetElem);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcatch(e)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\r\n\t\t\t\t// Check elem and its children, if it is a data wrapper, convert it into widget\r\n\t\t\t\tlaunchOnElem: function(elem)\r\n\t\t\t\t{\r\n\t\t\t\t\tif (elem.isContentEditable)\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t// if elem already binded with a widget, do nothing\r\n\t\t\t\t\tif (Kekule.Widget.getWidgetOnElem(elem, true))  // retain placeholder\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t// check if elem has widget specified attribute.\r\n\t\t\t\t\tif (Kekule.HtmlElementUtils.hasClass(elem, KekuleMoodle.WidgetDataWrapper.WRAPPER_HTML_CLASS))  // is a wrapper\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tKekuleMoodle.WidgetDataWrapper.convertWrapperElem(elem, true);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar children = Kekule.DomUtils.getDirectChildElems(elem);\r\n\t\t\t\t\t\tfor (var i = 0, l = children.length; i < l; ++i)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvar child = children[i];\r\n\t\t\t\t\t\t\tthis.launchOnElem(child);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\r\n\t\t\t\t//\r\n\t\t\t\tlaunchOnDoc: function(doc)\r\n\t\t\t\t{\r\n\t\t\t\t\tif (!doc)\r\n\t\t\t\t\t\tdoc = document;\r\n\t\t\t\t\tKekuleMoodle.WidgetDataWrapper.launchOnElem(doc.body);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\troot.KekuleMoodle = KekuleMoodle;\r\n\r\n\t\tKekule.X.domReady(function(){\r\n\t\t\tKekuleMoodle.WidgetDataWrapper.launchOnDoc(document);\r\n\t\t});\r\n\t}\r\n\r\n\treturn {\r\n\t\t'init': function(){\r\n\t\t\t//console.log('Kekule', Kekule);\r\n\t\t\tKekule._ready(init);\r\n\t\t}\r\n\t}\r\n});"],"file":"kekuleMoodle.min.js"}