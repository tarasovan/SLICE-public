!function(){"use strict";Kekule.Calculator={},Kekule.Calculator.getWorkerBasePath=function(){var e=Kekule.isUsingMinJs()?"workers/":"calculation/workers/";return e=Kekule.getScriptPath()+e},Kekule.Calculator.Base=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Calculator.Base",initProperties:function(){this.defineProp("async",{dataType:DataType.BOOL}),this.defineProp("worker",{dataType:DataType.OBJECT,setter:null})},initPropValues:function(){this.tryApplySuper("initPropValues"),this.setAsync(!0),this.reactWorkerMessageBind=this.reactWorkerMessage.bind(this),this.reactWorkerErrorBind=this.reactWorkerError.bind(this)},getWorkerBasePath:function(){return Kekule.Calculator.getWorkerBasePath()},execute:function(e,r,t){if(this._doneCallback=e,this._errCallback=r,this._msgCallback=t,this.getAsync()&&this.isWorkerSupported()&&this.createWorker()){var a=this.getWorker();this.workerStartCalc(a)}else{var o,i;try{i=this.executeSync(e)}catch(e){o=e}o?(Kekule.error(o),this.error(o)):i&&(o?this.error(o):this.done())}},executeSync:function(e){this._doneCallback=e;var r=this.doExecuteSync(e);return r&&this.done(),r},doExecuteSync:function(e){},error:function(e){Kekule.error(e),this._errCallback&&this._errCallback(e)},done:function(){this._doneCallback&&this._doneCallback.apply(this,arguments),this.getWorker()&&this.workerJobDone()},halt:function(){var e=this.getWorker();e&&(e.terminate(),this.error(Kekule.$L("ErrorMsg.CALC_TERMINATED_BY_USER")))},isWorkerSupported:function(){return Kekule.BrowserFeature.workers},createWorker:function(){if(this.isWorkerSupported()){var e=this.getWorkerScriptFile();if(e){var r=new Worker(e);return r.addEventListener("message",this.reactWorkerMessageBind),r.addEventListener("error",this.reactWorkerErrorBind),this.setPropStoreFieldValue("worker",r),r}}},getWorkerScriptFile:function(){return null},importWorkerScriptFile:function(e){this.postWorkerMessage({type:"importScript",url:e})},postWorkerMessage:function(e){var r=this.getWorker();r&&r.postMessage(e)},reactWorkerMessage:function(e){return this._msgCallback&&this._msgCallback(e.data),this.doReactWorkerMessage(e.data,e)},doReactWorkerMessage:function(e,r){},reactWorkerError:function(e){Kekule.error(e.message),this.error(e.message)},workerStartCalc:function(e){},workerJobDone:function(){var e=this.getWorker();e&&(e.terminate(),this.setPropStoreFieldValue("worker",null))}}),Kekule.Calculator.AbstractStructureGenerator=Class.create(Kekule.Calculator.Base,{CLASS_NAME:"Kekule.Calculator.AbstractStructureGenerator",initProperties:function(){this.defineProp("sourceMol",{dataType:"Kekule.StructureFragment",serializable:!1}),this.defineProp("generatedMol",{dataType:"Kekule.StructureFragment",serializable:!1}),this.defineProp("childObjMap",{dataType:"Kekule.MapEx",serializable:!1}),this.defineProp("options",{dataType:DataType.HASH,getter:function(){var e=this.getPropStoreFieldValue("options");return e||(e={},this.setPropStoreFieldValue("options",e)),e}})},getGeneratorCoordMode:function(){return Kekule.CoordMode.COORD3D},done:function(){this._modifySourceAccordingToGeneratedMol(this.getSourceMol(),this.getGeneratedMol(),this.getChildObjMap()),this.tryApplySuper("done")},_modifySourceAccordingToGeneratedMol:function(e,r,t){var a=t;if(a){var o=this.getGeneratorCoordMode(),i=a.getKeys();e.beginUpdate();try{for(var s=0,n=i.length;s<n;++s)if(i[s]instanceof Kekule.ChemStructureNode){var l=i[s],u=a.get(l).getCoordOfMode(o);l.setCoordOfMode(u,o)}}finally{e.endUpdate()}}}}),Kekule.Calculator.ServiceManager={_serviceInfos:{},_getServiceClassInfos:function(r,t){var a=e._serviceInfos[r];return!a&&t&&(a=[],e._serviceInfos[r]=a),a},_findServiceClassInfoItemIndex:function(r,t,a){var o=e._getServiceClassInfos(r,!1);if(o)for(var i=o.length-1;i>=0;--i){var s=o[i];if(s&&!(t&&s.serviceClass!==t||a&&s.id!==a))return i}return-1},register:function(r,t,a,o){var i=e._getServiceClassInfos(r,!0),s=e._findServiceClassInfoItemIndex(r,t);s>=0&&i.splice(s,1),i.push({serviceClass:t,id:a,priorityLevel:o||0})},unregister:function(r,t){var a=e._findServiceClassInfoItemIndex(r,t);a>=0&&e._getServiceClassInfos(r,!1).splice(a,1)},getServiceClass:function(r,t){var a=-1,o=null,i=e._getServiceClassInfos(r);if(i)for(var s=0,n=i.length-1;s<n;++s){var l=i[s];if(l){if(t&&l.id===t){o=l.serviceClass;break}(!o||l.priorityLevel>=a)&&(o=l.serviceClass,a=l.priorityLevel)}}return o}};var e=Kekule.Calculator.ServiceManager;Kekule.Calculator.Services={GEN2D:"2D structure generator",GEN3D:"3D structure generator"},Kekule.Calculator.generateStructure=function(r,t,a,o,i,s){var n=t||Kekule.Calculator.Services.GEN3D,l=e.getServiceClass(n);if(l){var u,c=new l;c.setChildObjMap&&(u=new Kekule.MapEx(!0),c.setChildObjMap(u));var k=function(e){i&&i(e)};try{c.setSourceMol(r),c.setOptions(a),a&&a.sync&&c.setAsync(!1),c.execute(function(){o&&o(c.getGeneratedMol(),u)},k,function(e){s&&s(e)})}catch(e){k(e)}return c}var d=Kekule.$L("ErrorMsg.CALC_SERVICE_UNAVAILABLE").format(n);return i&&i(d),null},Kekule.Calculator.generate3D=function(e,r,t,a,o){return Kekule.Calculator.generateStructure(e,Kekule.Calculator.Services.GEN3D,r,t,a,o)},Kekule.Calculator.generate2D=function(e,r,t,a,o){return Kekule.Calculator.generateStructure(e,Kekule.Calculator.Services.GEN2D,r,t,a,o)}}();