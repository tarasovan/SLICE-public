YUI.add("moodle-atto_kekulechem-button",function(e,t){var o=e.namespace("M.atto_kekulechem");o.Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{BTN_NAME_OBJ_INSERT:"kekuleChemObjInsert",BTN_NAME_SPECTRUM_INSERT:"kekuleSpectrumObjInsert",CHEM_OBJ_INSERTER_CLASS:"KekuleChemObjInserter",CHEM_OBJ_VIEWER_CLASS:"KekuleChemObjViewer",SPECTRUM_INSPECTOR_CLASS:"KekuleSpectrumInspector",CHEM_OBJ_TAGNAME:"img",initializer:function(){var e,t,r;this._preparingForSubmit=!1,this.get("attoKekulePluginPath"),this.addButton({buttonName:this.BTN_NAME_OBJ_INSERT,title:"captionKekuleChemObj",icon:"icons/kekulechem",iconComponent:"atto_kekulechem",callback:this._executeChemObjInserter}),this.get("attoKekulePluginPath"),this.addButton({buttonName:this.BTN_NAME_SPECTRUM_INSERT,title:"captionKekuleSpectrum",icon:"icons/kekulespectrum",iconComponent:"atto_kekulechem",callback:this._executeSpectrumObjInserter}),this._addEssentialFiles(),e=this.get("host"),t=this,r=e.textarea.getDOMNode().form,"undefined"!=typeof Kekule&&(Kekule.X.domReady(function(){t._setEditorConfigs()}),Kekule.X.domReady(function(){t._prepareForDisplay()})),r.onsubmit=function(){t._prepareForSubmit()},e.on("change",function(){t._prepareForDisplay()})},_setEditorConfigs:function(){Kekule.Editor.ChemSpaceEditorConfigs&&Kekule.Editor.ChemSpaceEditorConfigs.getInstance&&Kekule.Editor.ChemSpaceEditorConfigs.getInstance().getInteractionConfigs().setAllowUnknownAtomSymbol(!1)},_getPurifyHtml:function(){var e=this.get("purifyHtml");return Kekule.StrUtils.strToBool(e)},_addEssentialFiles:function(){var e=this.get("kekuleCssUrl"),t=this.get("kekuleMoodleCssUrl");this._addCssUrl(e),this._addCssUrl(t)},_addCssUrl:function(e){var t=document.createElement("link");t.setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href",e),document.head.appendChild(t)},_prepareForDisplay:function(){var e,t,r;if("undefined"!=typeof Kekule&&!this._preparingForSubmit&&this._getPurifyHtml())for(t=(e=this._getEditorRootElem().getElementsByTagName(o.ChemObjDataWrapperUtils.CHEM_OBJ_WRAPPER_TAGNAME)).length-1;0<=t;--t)(r=e[t])&&Kekule.HtmlElementUtils.hasClass(r,o.ChemObjDataWrapperUtils.CHEM_OBJ_WRAPPER_CLASSNAME)&&o.ChemObjDataWrapperUtils.replaceDataWrappersWithImg(r)},_prepareForSubmit:function(){var e,t,r,l;if(this._getPurifyHtml()){this._preparingForSubmit=!0;try{for(t=(e=this._getEditorRootElem().getElementsByTagName(this.CHEM_OBJ_TAGNAME)).length-1;0<=t;--t)(r=e[t])&&Kekule.HtmlElementUtils.hasClass(r,this.CHEM_OBJ_VIEWER_CLASS)&&o.ChemObjDataWrapperUtils.replaceImgsWithDataWrapper(r);this.markUpdated()}finally{l=this,function(){l._preparingForSubmit=!1}.defer()}}},_getSelectedInserterTargetNode:function(l,n){var e=this.get("host"),t=e.getSelectedNodes(),r=e.getSelection()[0],i=[],a=this;return!r||r.collapsed?null:(t.some(function(e){var t=null,r=e.getDOMNode();if(r&&r.tagName&&(t=a._getParentKekuleWidgetPlaceholderElement(r,a._getEditorRootElem(),l,n)),t&&(i.push(t),1<i.length))return!0}),1<=i.length?i[0]:null)},_getSelectedChemObjTarget:function(){return this._getSelectedInserterTargetNode(this.CHEM_OBJ_VIEWER_CLASS,"ChemWidget.Viewer")},_getSelectedSpectrumObjTarget:function(){return this._getSelectedInserterTargetNode(this.SPECTRUM_INSPECTOR_CLASS,"ChemWidget.SpectrumInspector")},_getEditorRootElem:function(){return this.get("host").editor.getDOMNode()},_getParentKekuleWidgetPlaceholderElement:function(e,t,r,l){return Kekule.HtmlElementUtils.hasClass(e,r)||0<=(e.getAttribute("data-kekule-widget")||"").indexOf(l)?e:e!==t?this._getParentChemObjElement(e.parentNode,t):null},_getParentChemObjElement:function(e,t){return this._getParentKekuleWidgetPlaceholderElement(e,t,this.CHEM_OBJ_VIEWER_CLASS,"ChemWidget.Viewer")},_getParentSpectrumObjElement:function(e,t){return this._getParentKekuleWidgetPlaceholderElement(e,t,this.SPECTRUM_INSPECTOR_CLASS,"ChemWidget.SpectrumInspector")},_executeChemObjInserter:function(){var e=this._getSelectedChemObjTarget();this._targetElem=e||null,this._setEditorConfigs(),this._openChemObjInserterDialog(e)},_executeSpectrumObjInserter:function(){var e=this._getSelectedSpectrumObjTarget();this._targetElem=e||null,this._openSpectrumObjInserterDialog(e)},_openInserterDialog:function(e,t,r,l,n){var i=null,a=this.buttons[t];return a&&(i=a.getDOMNode()),r.openModal(function(e){e===Kekule.Widget.DialogButtons.OK&&n()},i),e?l.importFromElem(e):l.setChemObj(null),function(){l.resized()}.bind(this).delay(),r},_openChemObjInserterDialog:function(e){var t,r;return this._chemObjInserterDialog||(this._chemObjInserterDialog=this._createChemObjInserterDialog()),t=this._chemObjInserterDialog,r=e?M.util.get_string("captionEditChemObj","atto_kekulechem"):M.util.get_string("captionAddChemObj","atto_kekulechem"),t.setCaption(r),this._openInserterDialog(e,this.BTN_NAME_OBJ_INSERT,t,this._chemObjInserter,this._submitChemObj.bind(this,e))},_openSpectrumObjInserterDialog:function(e){var t,r;return this._spectrumObjInserterDialog||(this._spectrumObjInserterDialog=this._createSpectrumObjInserterDialog()),t=this._spectrumObjInserterDialog,r=e?M.util.get_string("captionModifySpectrum","atto_kekulechem"):M.util.get_string("captionAddSpectrum","atto_kekulechem"),t.setCaption(r),this._openInserterDialog(e,this.BTN_NAME_SPECTRUM_INSERT,t,this._spectrumObjInserter,this._submitSpectrumObj.bind(this,e))},_createDialogForInsert:function(){var e,t=new Kekule.Widget.Dialog(document);return t.setButtons([Kekule.Widget.DialogButtons.OK,Kekule.Widget.DialogButtons.CANCEL]),(e=t.getClientElem()).style.minWidth="500px",e.style.minHeight="250px",t},_createChemObjInserterDialog:function(){var e,t=this._createDialogForInsert(),r=new Kekule.ChemWidget.ChemObjInserter(document);return r.setResizable(!0),(e=this._extractInserterToolButtons(this.get("chemObjInserterToolButtons")))&&r.setToolButtons(e),r.getViewer().setEditorProperties({predefinedSetting:"fullFunc",commonToolButtons:null,chemToolButtons:null,allowCreateNewChild:!0}),
r.setEnable3DStructureAutoGeneration(!!this.get("enableChemObjInserterAuto3DGeneration")||!1),r.appendToWidget(t),this._chemObjInserter=r,t},_createSpectrumObjInserterDialog:function(){var e,t=this._createDialogForInsert(),r=new Kekule.ChemWidget.SpectrumObjInserter(document);return r.setResizable(!0),(e=this._extractInserterToolButtons(this.get("chemObjInserterToolButtons")))&&r.setToolButtons(e),r.appendToWidget(t),this._spectrumObjInserter=r,t},_extractInserterToolButtons:function(e){var t,r,l;if(!e)return null;for(r=0,l=(t=e.split("\n")).length;r<l;++r)t[r]=t[r].trim();return t},_submitChemObj:function(l){var n=this,e=this._chemObjInserter;e.getExportImgElemAttributesAsync(null,null,function(e){var t,r;e["class"]||(e["class"]=""),e["class"]=" "+n.CHEM_OBJ_VIEWER_CLASS+" K-Transparent-Background",(t=n.get("host")).focus(),l?Kekule.DomUtils.setElemAttributes(l,e):(r=n._getNormalHtmlCode(e),t.insertContentAtFocusPoint(r)),n.markUpdated()})},_submitSpectrumObj:function(l){var n=this,e=this._spectrumObjInserter;e.getExportImgElemAttributesAsync(null,null,function(e){var t,r;e["class"]||(e["class"]=""),e["class"]=" "+n.SPECTRUM_INSPECTOR_CLASS+" K-Transparent-Background",(t=n.get("host")).focus(),l?Kekule.DomUtils.setElemAttributes(l,e):(r=n._getNormalHtmlCode(e),t.insertContentAtFocusPoint(r)),n.markUpdated()})},_getNormalHtmlCode:function(e){return this._generateElemHtmlCode(this.CHEM_OBJ_TAGNAME,null,e)},_generateElemHtmlCode:function(e,t,r){var l,n,i,a,s="<"+e,o=Kekule.ObjUtils.getOwnedFieldNames(r);for(l=0,n=o.length;l<n;++l)(i=o[l])&&(a=r[i],"className"===i&&(i="class"),s+=" "+i+"='"+(a=a&&(a=(a=(a=(a=a.toString()).replace('/"/g',"&quot;")).replace("/'/g","&#039;")).replace("/</g","&lt;")).replace("/>/g","&gt;"))+"'");return s+=">",t&&(s+=t),s+="</"+e+">"},_generateHtmlElemsCode:function(e){var t,r,l,n=e.children||[],i=e.tagName,a=e.content||"",s=Object.extend({},e);for(delete s.tagName,delete s.content,delete s.children,t="",r=0,l=n.length;r<l;++r)t+=this._generateHtmlElemsCode(n[r]);return this._generateElemHtmlCode(i,a+t,s)}},{ATTRS:{kekuleCssUrl:{value:""},kekuleMoodleCssUrl:{value:""},attoKekulePluginPath:{value:""},purifyHtml:{value:!1},enableChemObjInserterAuto3DGeneration:{value:!1},chemObjInserterToolButtons:{value:null},spectrumInserterToolButtons:{value:null}}}),o.ChemObjDataWrapperUtils={CHEM_OBJ_WRAPPER_TAGNAME:"span",CHEM_OBJ_DATA_TAGNAME:"span",CHEM_OBJ_IMG_TAGNAME:"img",CHEM_OBJ_WRAPPER_CLASSNAME:"Kekule-ChemObj-Wrapper",CHEM_OBJ_DATA_CLASSNAME:"Kekule-ChemObj-Wrapper-Data",CHEM_OBJ_IMG_CLASSNAME:"Kekule-ChemObj-Wrapper-Img",getWrapperDetails:function(e){var t,r,l,n,i,a;if(Kekule.HtmlElementUtils.hasClass(e,o.ChemObjDataWrapperUtils.CHEM_OBJ_WRAPPER_CLASSNAME)){if(t={},(r=Kekule.DomUtils.getDirectChildElems(e))&&r.length)for(l=0,n=r.length;l<n;++l)i=r[l],Kekule.HtmlElementUtils.hasClass(i,o.ChemObjDataWrapperUtils.CHEM_OBJ_DATA_CLASSNAME)?t.dataElement=i:Kekule.HtmlElementUtils.hasClass(i,o.ChemObjDataWrapperUtils.CHEM_OBJ_IMG_CLASSNAME)&&(t.imgElement=i);a=t.dataElement||e,t.srcData=Kekule.DomUtils.getElementText(a);try{t.data=JSON.parse(t.srcData)}catch(s){}return t}return null},updateWrapperElem:function(e,t){var r,l,n,i=o.ChemObjDataWrapperUtils.getWrapperDetails(e);i&&(r=e.ownerDocument,i.dataElement||(Kekule.DomUtils.setElementText(e,""),i.dataElement=r.createElement(o.ChemObjDataWrapperUtils.CHEM_OBJ_DATA_TAGNAME),i.dataElement.className=o.ChemObjDataWrapperUtils.CHEM_OBJ_DATA_CLASSNAME,e.appendChild(i.dataElement)),i.imgElement||(i.imgElement=r.createElement(o.ChemObjDataWrapperUtils.CHEM_OBJ_IMG_TAGNAME),i.imgElement.className=o.ChemObjDataWrapperUtils.CHEM_OBJ_IMG_CLASSNAME,e.appendChild(i.imgElement))),Kekule.HtmlElementUtils.addClass(i.dataElement,KekuleMoodle.WidgetDataWrapper.WRAPPER_DATA_HTML_CLASS),Kekule.DomUtils.setElementText(i.dataElement,JSON.stringify(t)),Kekule.StyleUtils.setDisplay(i.dataElement,"none"),l=i.imgElement,n={width:t.width,height:t.height,style:t.style,src:t.src},Kekule.DomUtils.setElemAttributes(l,n),Kekule.HtmlElementUtils.addClass(e,KekuleMoodle.WidgetDataWrapper.WRAPPER_HTML_CLASS)},createWrapperElem:function(e,t){var r=e.createElement(o.ChemObjDataWrapperUtils.CHEM_OBJ_WRAPPER_TAGNAME);return r.className=o.ChemObjDataWrapperUtils.CHEM_OBJ_WRAPPER_CLASSNAME,o.ChemObjDataWrapperUtils.updateWrapperElem(r,t),r},replaceDataWrappersWithImg:function(e){var t=o.ChemObjDataWrapperUtils.getWrapperDetails(e),r=Object.extend({dataWidget:t.widget},t.data),l=e.ownerDocument,n=e.parentNode,i=l.createElement("img");return Kekule.DomUtils.setElemAttributes(i,r),n.insertBefore(i,e),n.removeChild(e),i},replaceImgsWithDataWrapper:function(e){var t=e.ownerDocument,r=e.parentNode,l=Kekule.DomUtils.fetchAttributeValuesToJson(e),n=o.ChemObjDataWrapperUtils.createWrapperElem(t,l);return r.insertBefore(n,e),r.removeChild(e),n}}},"@VERSION@",{requires:["moodle-editor_atto-plugin","kekule","local_kekulejs","local_kekulejs/kekuleInitials"]});