{"version":3,"sources":["../src/editForm.js"],"names":["define","init","findViewerPlaceHolders","result","elems","document","getElementsByTagName","i","l","length","className","indexOf","push","getInputType","placeHolderElems","elem","form","inputTypeElem","elements","value","createChemViewers","inputType","placeHolder","ansData","molData","molDataType","ansJSON","JSON","parse","e","getAttribute","createChemViewer","BNS","Kekule","ChemWidget","ComponentWidgetNames","placeHolderName","name","ansIndex","getAnsRelatedElemIndex","widgetProps","restrainEditorWithCurrObj","editorProperties","container","createElement","linebreak","parentElem","parentNode","insertBefore","hideElem","Viewer","setPropValues","setPredefinedSetting","setToolButtons","loadData","saveData","openEditor","setResizable","setEnableEditFromVoid","addClassName","dataType","IO","MimeType","KEKULE_JSON","chemObj","loadMimeData","setChemObj","console","error","__answerIndex__","ansRelElems","getAnsRelatedElems","__answerRelElems__","on","reactChemObjLoad","viewer","currentTarget","target","viewerElem","getElement","answerElem","answer","smiles","smilesNoStereo","getChemObj","sAnswer","saveMimeData","SMILES","saveObj","stringify","matchResult","match","parseInt","getElementsByName","style","display","X","domReady","Editor","ChemSpaceEditorConfigs","getInstance","editorConfigs","getInteractionConfigs","setAllowUnknownAtomSymbol","placeHolders","_ready"],"mappings":"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","sourcesContent":["/**\r\n * Created by ginger on 2016/8/19.\r\n */\r\n\r\ndefine(/*'qtype_kekule_chem_base/editForm',*/ ['kekule'], function(){\r\n\r\nfunction init() {\r\n\r\n\t/*\r\n\tvar QTYPE_KEKULE_CHEM_FLAG = {};\r\n\r\n\t// initial function called by PHP\r\n\tfunction _startup(Y, qtypeKekuleFlagKey, qtypeKekuleFlagValue)\r\n\t{\r\n\t\tQTYPE_KEKULE_CHEM_FLAG.Key = qtypeKekuleFlagKey;\r\n\t\tQTYPE_KEKULE_CHEM_FLAG.Value = qtypeKekuleFlagValue;\r\n\t}\r\n\t*/\r\n\r\n\tfunction findViewerPlaceHolders() {\r\n\t\tvar result = [];\r\n\t\tvar elems = document.getElementsByTagName('textarea');\r\n\t\tfor (var i = 0, l = elems.length; i < l; ++i) {\r\n\t\t\tvar className = elems[i].className;\r\n\t\t\tif (className && className.indexOf('K-Chem-Question-Design-AnswerBlank') >= 0)  // is a place holder\r\n\t\t\t{\r\n\t\t\t\tresult.push(elems[i]);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn result;\r\n\t}\r\n\r\n\tfunction getInputType(placeHolderElems) {\r\n\t\tvar result = null;\r\n\t\tvar elem = placeHolderElems[0];\r\n\t\tvar form = elem && elem.form;\r\n\t\tif (form) {\r\n\t\t\tvar inputTypeElem = form.elements['inputtype'];\r\n\t\t\tresult = inputTypeElem && inputTypeElem.value;\r\n\t\t}\r\n\t\treturn result;\r\n\t}\r\n\r\n\tfunction createChemViewers(placeHolderElems) {\r\n\t\tvar inputType = getInputType(placeHolderElems);\r\n\t\tfor (var i = 0, l = placeHolderElems.length; i < l; ++i) {\r\n\t\t\tvar placeHolder = placeHolderElems[i];\r\n\t\t\tvar ansData = placeHolder.value;\r\n\t\t\tvar molData = null;\r\n\t\t\tvar molDataType = null;\r\n\t\t\ttry {\r\n\t\t\t\tvar ansJSON = JSON.parse(ansData);\r\n\t\t\t\tmolData = ansJSON.molData;\r\n\t\t\t\tmolDataType = ansJSON.molDataType;\r\n\t\t\t} catch (e) {\r\n\r\n\t\t\t}\r\n\t\t\tvar className = placeHolder.getAttribute('data-widget-class');\r\n\t\t\tcreateChemViewer(placeHolder, molData, molDataType, className, inputType);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction createChemViewer(placeHolder, molData, molDataType, className, inputType) {\r\n\t\tvar BNS = Kekule.ChemWidget.ComponentWidgetNames;\r\n\t\tvar placeHolderName = placeHolder.name || '';\r\n\t\tvar ansIndex = getAnsRelatedElemIndex(placeHolder);\r\n\t\tif (ansIndex >= 0) {\r\n\t\t\tvar widgetProps = {};\r\n\t\t\tif (inputType === '1')  // doc, allow input document\r\n\t\t\t{\r\n\t\t\t\twidgetProps.restrainEditorWithCurrObj = false;\r\n\t\t\t\twidgetProps.editorProperties = {\r\n\t\t\t\t\t'allowCreateNewChild': true\r\n\t\t\t\t};\r\n\t\t\t} else  // molecule\r\n\t\t\t{\r\n\t\t\t\twidgetProps.restrainEditorWithCurrObj = true;\r\n\t\t\t\twidgetProps.editorProperties = {\r\n\t\t\t\t\t'predefinedSetting': 'molOnly',\r\n\t\t\t\t\t'allowCreateNewChild': false\r\n\t\t\t\t};\r\n\t\t\t}\r\n\r\n\t\t\tvar container = document.createElement('span');\r\n\t\t\tvar linebreak = document.createElement('br');\r\n\t\t\t/*\r\n\t\t\tif (molData)\r\n\t\t\t\tcontainer.setAttribute('data-chem-obj', molData);\r\n\t\t\t*/\r\n\t\t\tvar parentElem = placeHolder.parentNode;\r\n\t\t\tparentElem.insertBefore(container, placeHolder);\r\n\t\t\tparentElem.insertBefore(linebreak, placeHolder);\r\n\t\t\t//parentElem.removeChild(placeHolder);\r\n\t\t\thideElem(placeHolder);\r\n\t\t\tvar result = new Kekule.ChemWidget.Viewer(container);\r\n\t\t\tresult.setPropValues(widgetProps);\r\n\t\t\tresult.setPredefinedSetting('editOnly').setToolButtons([BNS.loadData, BNS.saveData, BNS.openEditor])\r\n\t\t\t\t.setResizable(true).setEnableEditFromVoid(true);\r\n\t\t\tif (className)\r\n\t\t\t\tresult.addClassName(className);\r\n\t\t\tif (molData) {\r\n\t\t\t\tvar dataType = molDataType || Kekule.IO.MimeType.KEKULE_JSON;\r\n\t\t\t\ttry {\r\n\t\t\t\t\tvar chemObj = Kekule.IO.loadMimeData(molData, dataType);\r\n\t\t\t\t\tif (chemObj)\r\n\t\t\t\t\t\tresult.setChemObj(chemObj);\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tconsole.error(e);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// save ansIndex\r\n\t\t\tresult.__answerIndex__ = ansIndex;\r\n\t\t\tvar ansRelElems = getAnsRelatedElems(ansIndex);\r\n\t\t\tresult.__answerRelElems__ = ansRelElems;\r\n\t\t\tresult.on('load', reactChemObjLoad);\r\n\t\t\treturn result;\r\n\t\t} else\r\n\t\t\treturn null;\r\n\t}\r\n\r\n\tfunction reactChemObjLoad(e) {\r\n\t\tvar viewer = e.currentTarget || e.target;\r\n\t\tif (viewer instanceof Kekule.ChemWidget.Viewer)  // avoid event invoked by composer\r\n\t\t{\r\n\t\t\tvar viewerElem = viewer.getElement();\r\n\t\t\t/*\r\n\t\t\tvar ansIndex = viewer.__answerIndex__;\r\n\t\t\tvar ansRelElems = getAnsRelatedElems(ansIndex);\r\n\t\t\t*/\r\n\t\t\tvar ansRelElems = viewer.__answerRelElems__;\r\n\t\t\t//var molDataElem = ansRelElems.molData;\r\n\t\t\t//var smilesElem = ansRelElems.smiles;\r\n\t\t\tvar answerElem = ansRelElems.answer;\r\n\t\t\tif (/*molDataElem && smilesElem &&*/ answerElem) {\r\n\t\t\t\tvar molData = '', smiles = '', smilesNoStereo = '';\r\n\t\t\t\tvar chemObj = viewer.getChemObj();\r\n\t\t\t\tif (chemObj) {\r\n\t\t\t\t\tvar sAnswer = '';\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tmolData = Kekule.IO.saveMimeData(chemObj, Kekule.IO.MimeType.KEKULE_JSON);\r\n\t\t\t\t\t\tsmiles = Kekule.IO.saveMimeData(chemObj, Kekule.IO.MimeType.SMILES, {'ignoreStereo': false});\r\n\t\t\t\t\t\tsmilesNoStereo = Kekule.IO.saveMimeData(chemObj, Kekule.IO.MimeType.SMILES, {'ignoreStereo': true});\r\n\t\t\t\t\t} catch (e) {\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar saveObj = {\r\n\t\t\t\t\t\t'smiles': smiles,\r\n\t\t\t\t\t\t'smilesNoStereo': smilesNoStereo,\r\n\t\t\t\t\t\t'molDataType': Kekule.IO.MimeType.KEKULE_JSON,\r\n\t\t\t\t\t\t'molData': molData\r\n\t\t\t\t\t};\r\n\t\t\t\t\tsAnswer = JSON.stringify(saveObj);\r\n\t\t\t\t}\r\n\t\t\t\t//molDataElem.value = molData;\r\n\t\t\t\t//smilesElem.value = smiles;\r\n\t\t\t\tanswerElem.value = sAnswer;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction getAnsRelatedElemIndex(elem) {\r\n\t\tvar result = -1;\r\n\t\tvar name = elem.name;\r\n\t\tvar matchResult = name.match(/\\[(\\d+)\\]/);\r\n\t\tif (matchResult) {\r\n\t\t\tresult = parseInt(matchResult[1]);\r\n\t\t}\r\n\t\treturn result;\r\n\t}\r\n\r\n\tfunction getAnsRelatedElems(ansIndex) {\r\n\t\treturn {\r\n\t\t\t//'molData': document.getElementsByName('moldata[' + ansIndex + ']')[0],\r\n\t\t\t//'smiles': document.getElementsByName('smiles[' + ansIndex + ']')[0],\r\n\t\t\t'answer': document.getElementsByName('answer[' + ansIndex + ']')[0]\r\n\t\t};\r\n\t}\r\n\r\n\tfunction hideElem(elem) {\r\n\t\telem.style.display = 'none';\r\n\t}\r\n\r\n\tfunction init() {\r\n\t\t// avoid student to input unwanted pseudo atoms\r\n\t\tif (Kekule.Editor.ChemSpaceEditorConfigs && Kekule.Editor.ChemSpaceEditorConfigs.getInstance) {\r\n\t\t\tvar editorConfigs = Kekule.Editor.ChemSpaceEditorConfigs.getInstance();\r\n\t\t\teditorConfigs.getInteractionConfigs().setAllowUnknownAtomSymbol(false);\r\n\t\t}\r\n\r\n\t\tvar placeHolders = findViewerPlaceHolders();\r\n\t\tcreateChemViewers(placeHolders);\r\n\t}\r\n\r\n\tKekule.X.domReady(init);\r\n\r\n}\r\n\r\nreturn {\r\n\t'init': function(){\r\n\t\tKekule._ready(init);\r\n\t}\r\n}\r\n\r\n});"],"file":"editForm.min.js"}